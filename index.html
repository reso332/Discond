<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¯Ø±Ø¯Ø´Ø© Ù„Ø·ÙŠÙØ©</title>
<style>
  :root {
    --primary: #6d8ed1;
    --primary-light: #8fa8e0;
    --secondary: #e8f0fe;
    --text: #333;
    --text-light: #666;
    --white: #fff;
    --border: #ddd;
    --success: #4CAF50;
    --error: #ff4757;
    --warning: #ffa502;
  }
  
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  
  body {
    background: linear-gradient(135deg, #f5f7fa 0%, #e8f0fe 100%);
    min-height: 100vh;
    color: var(--text);
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }
  
  /* ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
  .login-screen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  
  .login-box {
    background: var(--white);
    padding: 40px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: 400px;
    text-align: center;
  }
  
  .login-box h2 {
    color: var(--primary);
    margin-bottom: 30px;
    font-weight: 500;
  }
  
  .login-input {
    width: 100%;
    padding: 12px 15px;
    margin-bottom: 20px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 16px;
  }
  
  .login-input:focus {
    outline: none;
    border-color: var(--primary);
  }
  
  .login-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 14px 30px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    width: 100%;
    transition: background 0.3s;
  }
  
  .login-btn:hover {
    background: var(--primary-light);
  }
  
  /* Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
  .chat-layout {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 20px;
    height: calc(100vh - 40px);
  }
  
  /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
  .sidebar {
    background: var(--white);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    overflow-y: auto;
  }
  
  .user-profile {
    text-align: center;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 20px;
  }
  
  .user-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 15px;
    border: 3px solid var(--secondary);
  }
  
  .user-name {
    font-size: 18px;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 10px;
  }
  
  .admin-badge {
    background: #ff4757;
    color: white;
    padding: 3px 10px;
    border-radius: 15px;
    font-size: 12px;
    display: inline-block;
    margin-right: 10px;
  }
  
  /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ù…Ù† */
  .admin-tools {
    background: #fff5f5;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    border: 1px solid #ffcccc;
    display: none;
  }
  
  .admin-tools h3 {
    color: #ff4757;
    margin-bottom: 15px;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .admin-tools h3:before {
    content: "ğŸ›¡ï¸";
  }
  
  .admin-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 15px;
  }
  
  .admin-btn {
    background: #ff4757;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
  }
  
  .admin-btn:hover {
    background: #ff6b81;
  }
  
  .admin-btn.secondary {
    background: var(--primary);
  }
  
  .admin-btn.secondary:hover {
    background: var(--primary-light);
  }
  
  .admin-input {
    width: 100%;
    padding: 8px;
    border: 1px solid var(--border);
    border-radius: 6px;
    margin-bottom: 10px;
  }
  
  /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† */
  .online-users {
    background: var(--secondary);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
  }
  
  .online-users h3 {
    color: var(--primary);
    margin-bottom: 15px;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .online-users h3:before {
    content: "ğŸ‘¥";
  }
  
  .users-list {
    max-height: 200px;
    overflow-y: auto;
  }
  
  .user-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px;
    border-bottom: 1px solid rgba(0,0,0,0.1);
  }
  
  .user-item:last-child {
    border-bottom: none;
  }
  
  .user-item-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    object-fit: cover;
  }
  
  .user-item-name {
    flex: 1;
    font-size: 14px;
  }
  
  .user-item-admin {
    background: #ff4757;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
  }
  
  .online-count {
    background: var(--primary);
    color: white;
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 12px;
    margin-right: 10px;
  }
  
  /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­ÙƒÙ… */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
  }
  
  .modal-content {
    background: var(--white);
    padding: 30px;
    border-radius: 12px;
    width: 90%;
    max-width: 400px;
  }
  
  .modal h3 {
    color: var(--primary);
    margin-bottom: 20px;
    text-align: center;
  }
  
  .modal-buttons {
    display: flex;
    gap: 10px;
  }
  
  .modal-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
  }
  
  .submit-btn {
    background: var(--primary);
    color: white;
  }
  
  .cancel-btn {
    background: var(--border);
    color: var(--text);
  }
  
  .danger-btn {
    background: #ff4757;
    color: white;
  }
  
  /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø§Øª */
  .chat-area {
    display: flex;
    flex-direction: column;
    background: var(--white);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  }
  
  .messages-container {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #fafafa;
  }
  
  .chat-locked {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 100;
  }
  
  .chat-locked h3 {
    color: #ff4757;
    margin-bottom: 10px;
  }
  
  .message {
    display: flex;
    margin-bottom: 20px;
    max-width: 80%;
  }
  
  .message.other {
    align-self: flex-start;
  }
  
  .message.self {
    align-self: flex-end;
    flex-direction: row-reverse;
  }
  
  .message.admin {
    border-right: 3px solid #ff4757;
  }
  
  .message.muted {
    opacity: 0.5;
  }
  
  .message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    margin: 0 10px;
  }
  
  .message-content {
    background: var(--secondary);
    padding: 12px 16px;
    border-radius: 12px;
    max-width: calc(100% - 60px);
    position: relative;
  }
  
  .message.self .message-content {
    background: var(--primary-light);
    color: white;
  }
  
  .message.admin .message-content {
    background: #fff5f5;
    border: 1px solid #ffcccc;
  }
  
  .message-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
  }
  
  .message-name {
    font-weight: 600;
    font-size: 14px;
  }
  
  .message.admin .message-name {
    color: #ff4757;
  }
  
  .message-time {
    font-size: 12px;
    color: var(--text-light);
  }
  
  .message.self .message-time {
    color: rgba(255, 255, 255, 0.8);
  }
  
  .message-text {
    line-height: 1.5;
  }
  
  .delete-btn {
    position: absolute;
    left: -25px;
    top: 50%;
    transform: translateY(-50%);
    background: #ff4757;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    cursor: pointer;
    font-size: 12px;
    display: none;
  }
  
  .message:hover .delete-btn {
    display: block;
  }
  
  /* Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
  .input-area {
    padding: 20px;
    border-top: 1px solid var(--border);
    background: var(--white);
    position: relative;
  }
  
  .chat-locked .input-area {
    filter: blur(2px);
    pointer-events: none;
  }
  
  .message-input-row {
    display: flex;
    gap: 10px;
  }
  
  #message-input {
    flex: 1;
    padding: 12px 15px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 16px;
    resize: none;
    height: 60px;
  }
  
  #message-input:disabled {
    background: #f5f5f5;
    cursor: not-allowed;
  }
  
  #message-input:focus {
    outline: none;
    border-color: var(--primary);
  }
  
  #send-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 0 25px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.3s;
  }
  
  #send-btn:disabled {
    background: #cccccc;
    cursor: not-allowed;
  }
  
  #send-btn:hover:not(:disabled) {
    background: var(--primary-light);
  }
  
  .status {
    text-align: center;
    padding: 10px;
    font-size: 14px;
    color: var(--text-light);
    background: var(--secondary);
  }
  
  .chat-status {
    background: #fff5f5;
    color: #ff4757;
    padding: 10px;
    text-align: center;
    font-weight: bold;
  }
  
  /* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 3000;
    animation: slideIn 0.3s ease;
    border-right: 4px solid var(--primary);
    max-width: 300px;
  }
  
  .notification.error {
    border-right-color: #ff4757;
  }
  
  .notification.success {
    border-right-color: #4CAF50;
  }
  
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  /* Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø¬ÙˆØ§Ù„ */
  @media (max-width: 768px) {
    .chat-layout {
      grid-template-columns: 1fr;
    }
    
    .sidebar {
      display: none;
    }
    
    .message {
      max-width: 90%;
    }
  }
</style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="loginScreen" class="login-screen">
  <div class="login-box">
    <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù„Ø·ÙŠÙØ©</h2>
    <input type="text" id="userName" class="login-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" maxlength="20">
    <input type="text" id="userAvatar" class="login-input" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
    <p style="color: var(--text-light); font-size: 14px; margin-bottom: 20px;">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ±Ùƒ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© ÙØ§Ø±ØºØ§Ù‹</p>
    
    <button id="loginBtn" class="login-btn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</button>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ù…Ù† -->
<div id="adminModal" class="modal" style="display: none;">
  <div class="modal-content">
    <h3 id="modalTitle">ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ù…Ù†</h3>
    <div id="modalBody">
      <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙŠØªØºÙŠØ± Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ -->
    </div>
    <div class="modal-buttons">
      <button id="modalConfirmBtn" class="modal-btn submit-btn">ØªØ£ÙƒÙŠØ¯</button>
      <button id="modalCancelBtn" class="modal-btn cancel-btn">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<div class="container" style="display: none;" id="mainApp">
  <div class="chat-layout">
    
    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
    <div class="chat-area">
      <!-- Ø­Ø§Ù„Ø© Ù‚ÙÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
      <div id="chatLocked" class="chat-locked" style="display: none;">
        <h3>ğŸ”’ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…ØºÙ„Ù‚Ø© Ù…Ø¤Ù‚ØªØ§Ù‹</h3>
        <p id="lockReason">Ø³ÙŠØªÙ… ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹...</p>
        <p id="lockTime" style="font-size: 12px; color: #666;"></p>
      </div>
      
      <div id="messagesContainer" class="messages-container">
        <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
      </div>
      
      <div class="input-area">
        <div class="message-input-row">
          <textarea id="message-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."></textarea>
          <button id="send-btn">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
      </div>
      
      <div class="status">
        <span id="onlineStatus">âœ“ Ù…ØªØµÙ„</span>
        â€¢ <span id="messageCount">0 Ø±Ø³Ø§Ù„Ø©</span>
        â€¢ <span id="onlineUsersCount">0 Ù…ØªØµÙ„</span>
      </div>
    </div>
    
    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
    <div class="sidebar">
      <div class="user-profile">
        <img id="profileAvatar" class="user-avatar" src="https://ui-avatars.com/api/?name=Ù…Ø³ØªØ®Ø¯Ù…&background=6d8ed1&color=fff" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù">
        <div class="user-name" id="profileName">
          <span id="adminBadge" class="admin-badge" style="display: none;">Ø¥Ø¯Ù…Ù†</span>
          Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        </div>
        <div style="color: var(--text-light); font-size: 14px; margin-bottom: 10px;">Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø´Ø·</div>
        <div style="color: var(--primary); font-size: 12px; background: #e8f0fe; padding: 5px 10px; border-radius: 15px;">
          ID: <span id="userIdText">---</span>
        </div>
      </div>
      
      <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† -->
      <div class="online-users">
        <h3>
          <span class="online-count" id="onlineCount">0</span>
          Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…ØªØµÙ„ÙˆÙ†
        </h3>
        <div class="users-list" id="usersList">
          <!-- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙŠØ¸Ù‡Ø±ÙˆÙ† Ù‡Ù†Ø§ -->
        </div>
      </div>
      
      <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ù…Ù† (ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ø¥Ø¯Ù…Ù†) -->
      <div id="adminTools" class="admin-tools">
        <h3>Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ù…Ù†</h3>
        
        <div class="admin-buttons">
          <button id="clearChatBtn" class="admin-btn">Ù…Ø³Ø­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</button>
          <button id="lockChatBtn" class="admin-btn">Ù‚ÙÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</button>
        </div>
        
        <div class="admin-buttons">
          <button id="muteUserBtn" class="admin-btn secondary">ÙƒØªÙ… Ù…Ø³ØªØ®Ø¯Ù…</button>
          <button id="lockMessageBtn" class="admin-btn secondary">Ø±Ø³Ø§Ù„Ø© Ù…Ù‚ÙÙ„Ø©</button>
        </div>
        
        <input type="text" id="targetUserId" class="admin-input" placeholder="Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù">
        <input type="text" id="lockDuration" class="admin-input" placeholder="Ù…Ø¯Ø© Ø§Ù„Ù‚ÙÙ„ Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚">
        
        <div style="font-size: 12px; color: #666; margin-top: 10px; text-align: center;">
          Ù„ØªÙƒÙˆÙ† Ø¥Ø¯Ù…Ù†ØŒ ØºÙŠØ± isAdmin Ø¥Ù„Ù‰ true ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, onValue, set, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyC8jmHxQ5tIwuh9J_Y9TpovequFVigiXYw",
    authDomain: "disconde-17f43.firebaseapp.com",
    databaseURL: "https://disconde-17f43-default-rtdb.firebaseio.com",
    projectId: "disconde-17f43",
    storageBucket: "disconde-17f43.firebasestorage.app",
    messagingSenderId: "1009347423340",
    appId: "1:1009347423340:web:a86dee5c542544ab223c49",
    measurementId: "G-8Q05LMTRDX"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Ù…Ø±Ø§Ø¬Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  const messagesRef = ref(db, 'messages');
  const usersRef = ref(db, 'users');
  const chatSettingsRef = ref(db, 'settings/chat');
  const mutedUsersRef = ref(db, 'mutedUsers');

  // Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„ØµÙØ­Ø©
  const loginScreen = document.getElementById('loginScreen');
  const mainApp = document.getElementById('mainApp');
  const loginBtn = document.getElementById('loginBtn');
  const userNameInput = document.getElementById('userName');
  const userAvatarInput = document.getElementById('userAvatar');
  const profileName = document.getElementById('profileName');
  const profileAvatar = document.getElementById('profileAvatar');
  const adminBadge = document.getElementById('adminBadge');
  const adminTools = document.getElementById('adminTools');
  const userIdText = document.getElementById('userIdText');
  const messagesContainer = document.getElementById('messagesContainer');
  const messageInput = document.getElementById('message-input');
  const sendBtn = document.getElementById('send-btn');
  const messageCount = document.getElementById('messageCount');
  const onlineStatus = document.getElementById('onlineStatus');
  const onlineUsersCount = document.getElementById('onlineUsersCount');
  const onlineCount = document.getElementById('onlineCount');
  const usersList = document.getElementById('usersList');
  const chatLocked = document.getElementById('chatLocked');
  const lockReason = document.getElementById('lockReason');
  const lockTime = document.getElementById('lockTime');

  // Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ù…Ù†
  const clearChatBtn = document.getElementById('clearChatBtn');
  const lockChatBtn = document.getElementById('lockChatBtn');
  const muteUserBtn = document.getElementById('muteUserBtn');
  const lockMessageBtn = document.getElementById('lockMessageBtn');
  const targetUserId = document.getElementById('targetUserId');
  const lockDuration = document.getElementById('lockDuration');

  // Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
  const adminModal = document.getElementById('adminModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  const modalConfirmBtn = document.getElementById('modalConfirmBtn');
  const modalCancelBtn = document.getElementById('modalCancelBtn');

  // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
  let currentUser = {
    name: '',
    avatar: '',
    userId: '',
    isAdmin: false
  };

  // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ­ÙƒÙ…
  let currentAction = '';
  let chatLockedUntil = null;
  let mutedUsers = {};
  let onlineUsers = {};

  // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  loginBtn.addEventListener('click', () => {
    const name = userNameInput.value.trim();
    const avatar = userAvatarInput.value.trim();
    
    if (!name) {
      showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
      return;
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    currentUser.userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    currentUser.name = name;
    currentUser.avatar = avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=6d8ed1&color=fff`;
    currentUser.isAdmin = false; // Ø¯Ø§Ø¦Ù…Ø§Ù‹ false Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    
    // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase
    set(ref(db, `users/${currentUser.userId}`), {
      name: currentUser.name,
      avatar: currentUser.avatar,
      isAdmin: false, // ÙŠØ¨Ù‚Ù‰ false Ø¥Ù„Ø§ Ø¥Ø°Ø§ ØºÙŠØ±ØªÙ‡ ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
      lastSeen: serverTimestamp(),
      joinedAt: serverTimestamp(),
      isOnline: true
    });
    
    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    profileName.textContent = currentUser.name;
    profileAvatar.src = currentUser.avatar;
    userIdText.textContent = currentUser.userId.substring(0, 10) + '...';
    
    // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø§Øª
    loginScreen.style.display = 'none';
    mainApp.style.display = 'block';
    
    // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    messageInput.focus();
    
    // Ù…Ø±Ø§Ù‚Ø¨Ø© ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¥Ø¯Ù…Ù†
    monitorAdminStatus();
    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
    monitorChatSettings();
    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ÙƒØªÙˆÙ…ÙŠÙ†
    monitorMutedUsers();
    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†
    monitorOnlineUsers();
  });

  // Ù…Ø±Ø§Ù‚Ø¨Ø© ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¥Ø¯Ù…Ù†
  function monitorAdminStatus() {
    const userRef = ref(db, `users/${currentUser.userId}/isAdmin`);
    
    onValue(userRef, (snapshot) => {
      if (snapshot.exists()) {
        const isAdmin = snapshot.val();
        currentUser.isAdmin = isAdmin;
        
        if (isAdmin) {
          adminBadge.style.display = 'inline-block';
          adminTools.style.display = 'block';
          profileName.style.color = '#ff4757';
          showNotification('Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ø¥Ø¯Ù…Ù† ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©', 'success');
        } else {
          adminBadge.style.display = 'none';
          adminTools.style.display = 'none';
          profileName.style.color = '';
        }
      }
    });
  }

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
  function monitorChatSettings() {
    onValue(chatSettingsRef, (snapshot) => {
      if (snapshot.exists()) {
        const settings = snapshot.val();
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù‚ÙÙ„
        if (settings.isLocked) {
          chatLocked.style.display = 'flex';
          messageInput.disabled = true;
          sendBtn.disabled = true;
          
          lockReason.textContent = settings.lockReason || 'Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…ØºÙ„Ù‚Ø© Ù…Ø¤Ù‚ØªØ§Ù‹ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ù…Ù†';
          
          if (settings.lockedUntil) {
            const lockDate = new Date(settings.lockedUntil);
            const now = new Date();
            const diff = lockDate - now;
            
            if (diff > 0) {
              const minutes = Math.ceil(diff / (1000 * 60));
              lockTime.textContent = `Ø³ØªÙØªØ­ Ø¨Ø¹Ø¯ ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
              chatLockedUntil = settings.lockedUntil;
            } else {
              // Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù„Ù‚ÙÙ„
              set(chatSettingsRef, {
                isLocked: false,
                lockedBy: null,
                lockReason: null,
                lockedUntil: null,
                lockedAt: null
              });
            }
          }
        } else {
          chatLocked.style.display = 'none';
          messageInput.disabled = false;
          sendBtn.disabled = false;
          chatLockedUntil = null;
        }
      }
    });
  }

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ÙƒØªÙˆÙ…ÙŠÙ†
  function monitorMutedUsers() {
    onValue(mutedUsersRef, (snapshot) => {
      if (snapshot.exists()) {
        mutedUsers = snapshot.val();
      } else {
        mutedUsers = {};
      }
    });
  }

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†
  function monitorOnlineUsers() {
    onValue(usersRef, (snapshot) => {
      if (snapshot.exists()) {
        const users = snapshot.val();
        onlineUsers = {};
        usersList.innerHTML = '';
        
        let count = 0;
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
        set(ref(db, `users/${currentUser.userId}/lastSeen`), serverTimestamp());
        
        for (const userId in users) {
          const user = users[userId];
          onlineUsers[userId] = user;
          
          // Ø§Ø¹ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ØªØµÙ„Ø§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† lastSeen ÙÙŠ Ø¢Ø®Ø± 2 Ø¯Ù‚ÙŠÙ‚Ø©
          const lastSeen = user.lastSeen ? new Date(user.lastSeen) : new Date();
          const now = new Date();
          const diff = (now - lastSeen) / (1000 * 60); // Ø§Ù„ÙØ§Ø±Ù‚ Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
          
          if (diff < 2) { // Ù…ØªØµÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± Ù…Ù†Ø° Ø£Ù‚Ù„ Ù…Ù† Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†
            count++;
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
            const userItem = document.createElement('div');
            userItem.className = 'user-item';
            userItem.innerHTML = `
              <img src="${user.avatar}" class="user-item-avatar" alt="${user.name}">
              <span class="user-item-name">${user.name}</span>
              ${user.isAdmin ? '<span class="user-item-admin">Ø¥Ø¯Ù…Ù†</span>' : ''}
            `;
            usersList.appendChild(userItem);
          }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
        onlineCount.textContent = count;
        onlineUsersCount.textContent = `${count} Ù…ØªØµÙ„`;
      } else {
        onlineUsers = {};
        usersList.innerHTML = '';
        onlineCount.textContent = '0';
        onlineUsersCount.textContent = '0 Ù…ØªØµÙ„';
      }
    });
  }

  // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¯Ù…Ù†
  function showAdminModal(title, body, confirmText = 'ØªØ£ÙƒÙŠØ¯', cancelText = 'Ø¥Ù„ØºØ§Ø¡', action = '') {
    modalTitle.textContent = title;
    modalBody.innerHTML = body;
    modalConfirmBtn.textContent = confirmText;
    modalCancelBtn.textContent = cancelText;
    currentAction = action;
    adminModal.style.display = 'flex';
  }

  // Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¯Ù…Ù†
  function hideAdminModal() {
    adminModal.style.display = 'none';
    currentAction = '';
    targetUserId.value = '';
    lockDuration.value = '';
  }

  // Ø²Ø± Ù…Ø³Ø­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
  clearChatBtn.addEventListener('click', () => {
    if (!currentUser.isAdmin) return;
    
    showAdminModal(
      'Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„',
      '<p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ØŸ</p><p style="color: #ff4757; font-size: 14px;">Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡</p>',
      'Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„',
      'Ø¥Ù„ØºØ§Ø¡',
      'clear_chat'
    );
  });

  // Ø²Ø± Ù‚ÙÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
  lockChatBtn.addEventListener('click', () => {
    if (!currentUser.isAdmin) return;
    
    showAdminModal(
      'Ù‚ÙÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©',
      `
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 8px;">Ø§Ù„Ù…Ø¯Ø© (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚):</label>
        <input type="number" id="modalLockDuration" class="admin-input" value="30" min="1" max="1440">
      </div>
      <div>
        <label style="display: block; margin-bottom: 8px;">Ø§Ù„Ø³Ø¨Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
        <textarea id="modalLockReason" class="admin-input" placeholder="Ø³Ø¨Ø¨ Ù‚ÙÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©..." rows="3"></textarea>
      </div>
      `,
      'Ù‚ÙÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©',
      'Ø¥Ù„ØºØ§Ø¡',
      'lock_chat'
    );
  });

  // Ø²Ø± ÙƒØªÙ… Ù…Ø³ØªØ®Ø¯Ù…
  muteUserBtn.addEventListener('click', () => {
    if (!currentUser.isAdmin) return;
    
    showAdminModal(
      'ÙƒØªÙ… Ù…Ø³ØªØ®Ø¯Ù…',
      `
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 8px;">Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
        <input type="text" id="modalTargetUser" class="admin-input" placeholder="user_123456789...">
      </div>
      <div>
        <label style="display: block; margin-bottom: 8px;">Ø§Ù„Ù…Ø¯Ø© (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚):</label>
        <input type="number" id="modalMuteDuration" class="admin-input" value="60" min="1" max="10080">
      </div>
      `,
      'ÙƒØªÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
      'Ø¥Ù„ØºØ§Ø¡',
      'mute_user'
    );
  });

  // Ø²Ø± Ø±Ø³Ø§Ù„Ø© Ù…Ù‚ÙÙ„Ø©
  lockMessageBtn.addEventListener('click', () => {
    if (!currentUser.isAdmin) return;
    
    showAdminModal(
      'Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù…Ù‚ÙÙ„Ø©',
      `
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 8px;">Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</label>
        <textarea id="modalLockedMessage" class="admin-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ù‚ÙÙ„Ø© Ù‡Ù†Ø§..." rows="4"></textarea>
      </div>
      <div>
        <label style="display: block; margin-bottom: 8px;">Ø§Ù„Ù…Ø¯Ø© (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚):</label>
        <input type="number" id="modalMessageLockDuration" class="admin-input" value="5" min="1" max="1440">
      </div>
      `,
      'Ø¥Ø±Ø³Ø§Ù„',
      'Ø¥Ù„ØºØ§Ø¡',
      'locked_message'
    );
  });

  // ØªØ£ÙƒÙŠØ¯ Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¥Ø¯Ù…Ù†
  modalConfirmBtn.addEventListener('click', () => {
    switch (currentAction) {
      case 'clear_chat':
        // Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        remove(messagesRef);
        showNotification('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„', 'success');
        break;
        
      case 'lock_chat':
        const duration = parseInt(document.getElementById('modalLockDuration').value) || 30;
        const reason = document.getElementById('modalLockReason').value.trim();
        
        const lockUntil = new Date();
        lockUntil.setMinutes(lockUntil.getMinutes() + duration);
        
        set(chatSettingsRef, {
          isLocked: true,
          lockedBy: currentUser.userId,
          lockReason: reason || 'Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…ØºÙ„Ù‚Ø© Ù…Ø¤Ù‚ØªØ§Ù‹ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ù…Ù†',
          lockedUntil: lockUntil.toISOString(),
          lockedAt: serverTimestamp()
        });
        
        showNotification(`ØªÙ… Ù‚ÙÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù„Ù…Ø¯Ø© ${duration} Ø¯Ù‚ÙŠÙ‚Ø©`, 'success');
        break;
        
      case 'mute_user':
        const targetUser = document.getElementById('modalTargetUser').value.trim();
        const muteDuration = parseInt(document.getElementById('modalMuteDuration').value) || 60;
        
        if (!targetUser) {
          showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
          return;
        }
        
        const muteUntil = new Date();
        muteUntil.setMinutes(muteUntil.getMinutes() + muteDuration);
        
        set(ref(db, `mutedUsers/${targetUser}`), {
          mutedBy: currentUser.userId,
          mutedUntil: muteUntil.toISOString(),
          mutedAt: serverTimestamp()
        });
        
        showNotification(`ØªÙ… ÙƒØªÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù…Ø¯Ø© ${muteDuration} Ø¯Ù‚ÙŠÙ‚Ø©`, 'success');
        break;
        
      case 'locked_message':
        const lockedMessage = document.getElementById('modalLockedMessage').value.trim();
        const messageLockDuration = parseInt(document.getElementById('modalMessageLockDuration').value) || 5;
        
        if (!lockedMessage) {
          showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 'error');
          return;
        }
        
        // Ù‚ÙÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø£ÙˆÙ„Ø§Ù‹
        const messageLockUntil = new Date();
        messageLockUntil.setMinutes(messageLockUntil.getMinutes() + messageLockDuration);
        
        set(chatSettingsRef, {
          isLocked: true,
          lockedBy: currentUser.userId,
          lockReason: 'Ø±Ø³Ø§Ù„Ø© Ù…Ù‚ÙÙ„Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ù…Ù†',
          lockedUntil: messageLockUntil.toISOString(),
          lockedAt: serverTimestamp()
        });
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ù‚ÙÙ„Ø©
        setTimeout(() => {
          push(messagesRef, {
            userId: currentUser.userId,
            userName: currentUser.name + ' (Ø¥Ø¯Ù…Ù†)',
            userAvatar: currentUser.avatar,
            text: 'ğŸ”’ ' + lockedMessage,
            timestamp: serverTimestamp(),
            isAdmin: true
          });
          
          // ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
          setTimeout(() => {
            set(chatSettingsRef, {
              isLocked: false,
              lockedBy: null,
              lockReason: null,
              lockedUntil: null,
              lockedAt: null
            });
          }, messageLockDuration * 60 * 1000);
          
        }, 1000);
        
        showNotification(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ù‚ÙÙ„Ø© Ù„Ù…Ø¯Ø© ${messageLockDuration} Ø¯Ù‚ÙŠÙ‚Ø©`, 'success');
        break;
    }
    
    hideAdminModal();
  });

  // Ø¥Ù„ØºØ§Ø¡ Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¥Ø¯Ù…Ù†
  modalCancelBtn.addEventListener('click', hideAdminModal);

  // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
  function sendMessage() {
    const text = messageInput.value.trim();
    
    if (!text) {
      showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø±Ø³Ø§Ù„Ø©', 'error');
      return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒØªÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (mutedUsers[currentUser.userId]) {
      const muteUntil = new Date(mutedUsers[currentUser.userId].mutedUntil);
      const now = new Date();
      
      if (muteUntil > now) {
        const diff = Math.ceil((muteUntil - now) / (1000 * 60));
        showNotification(`Ø£Ù†Øª Ù…ÙƒØªÙˆÙ… Ù„Ù…Ø¯Ø© ${diff} Ø¯Ù‚ÙŠÙ‚Ø© Ø£Ø®Ø±Ù‰`, 'error');
        return;
      } else {
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒØªÙ… Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø©
        remove(ref(db, `mutedUsers/${currentUser.userId}`));
      }
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
    if (chatLockedUntil) {
      const lockUntil = new Date(chatLockedUntil);
      const now = new Date();
      
      if (lockUntil > now) {
        showNotification('Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…ØºÙ„Ù‚Ø© Ù…Ø¤Ù‚ØªØ§Ù‹', 'error');
        return;
      }
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Firebase
    push(messagesRef, {
      userId: currentUser.userId,
      userName: currentUser.name + (currentUser.isAdmin ? ' (Ø¥Ø¯Ù…Ù†)' : ''),
      userAvatar: currentUser.avatar,
      text: text,
      timestamp: serverTimestamp(),
      isAdmin: currentUser.isAdmin
    });
    
    // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    messageInput.value = '';
    messageInput.focus();
  }

  // Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø²Ø±
  sendBtn.addEventListener('click', sendMessage);

  // Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±
  messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  onChildAdded(messagesRef, (snapshot) => {
    const message = snapshot.val();
    const messageId = snapshot.key;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒØªÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø±Ø³Ù„
    if (mutedUsers[message.userId] && !currentUser.isAdmin) {
      const muteUntil = new Date(mutedUsers[message.userId].mutedUntil);
      const now = new Date();
      
      if (muteUntil > now) {
        // Ù„Ø§ ØªØ¸Ù‡Ø± Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙƒØªÙˆÙ… Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†
        return;
      }
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${message.userId === currentUser.userId ? 'self' : 'other'} ${message.isAdmin ? 'admin' : ''}`;
    messageDiv.dataset.messageId = messageId;
    messageDiv.dataset.userId = message.userId;
    
    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
    let timeString = 'Ø§Ù„Ø¢Ù†';
    if (message.timestamp) {
      const time = new Date(message.timestamp);
      if (!isNaN(time.getTime())) {
        timeString = time.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
      }
    }
    
    messageDiv.innerHTML = `
      <img src="${message.userAvatar}" class="message-avatar" alt="${message.userName}">
      <div class="message-content">
        <div class="message-header">
          <span class="message-name">${message.userName}</span>
          <span class="message-time">${timeString}</span>
        </div>
        <div class="message-text">${message.text}</div>
      </div>
      ${currentUser.isAdmin ? `<button class="delete-btn" onclick="deleteMessage('${messageId}')">Ã—</button>` : ''}
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  });

  // Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ù„Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ù† onclick)
  window.deleteMessage = function(messageId) {
    if (!currentUser.isAdmin) return;
    
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ')) {
      remove(ref(db, `messages/${messageId}`));
      showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 'success');
    }
  };

  // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
  onValue(messagesRef, (snapshot) => {
    const count = snapshot.size || 0;
    messageCount.textContent = `${count} Ø±Ø³Ø§Ù„Ø©`;
  });

  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
  window.addEventListener('online', () => {
    onlineStatus.textContent = 'âœ“ Ù…ØªØµÙ„';
    onlineStatus.style.color = '';
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
    if (currentUser.userId) {
      set(ref(db, `users/${currentUser.userId}/lastSeen`), serverTimestamp());
    }
  });
  
  window.addEventListener('offline', () => {
    onlineStatus.textContent = 'âœ— ØºÙŠØ± Ù…ØªØµÙ„';
    onlineStatus.style.color = '#ff4757';
  });

  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù†ØªØ¸Ø§Ù…
  setInterval(() => {
    if (currentUser.userId && navigator.onLine) {
      set(ref(db, `users/${currentUser.userId}/lastSeen`), serverTimestamp());
    }
  }, 30000); // ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©

  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
  window.addEventListener('beforeunload', () => {
    if (currentUser.userId) {
      // Ù„Ø§ ØªØ­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ ÙÙ‚Ø· ØªØ­Ø¯ÙŠØ« lastSeen
      set(ref(db, `users/${currentUser.userId}/lastSeen`), serverTimestamp());
    }
  });

</script>

</body>
</html>
