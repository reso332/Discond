<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Discond</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  :root {
    --primary: #6d8ed1;
    --primary-light: #8fa8e0;
    --secondary: #e8f0fe;
    --text: #333;
    --text-light: #666;
    --white: #fff;
    --border: #ddd;
    --success: #4CAF50;
    --error: #ff4757;
    --warning: #ffa502;
  }
  
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
  }
  
  html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;
    position: fixed;
  }
  
  body {
    background: linear-gradient(135deg, #f5f7fa 0%, #e8f0fe 100%);
    min-height: 100vh;
    color: var(--text);
    touch-action: manipulation;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    height: 100%;
    width: 100%;
  }
  
  /* تسجيل الدخول */
  .login-screen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    padding: 20px;
  }
  
  .login-box {
    background: var(--white);
    padding: 40px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: 400px;
    text-align: center;
  }
  
  .login-box h2 {
    color: var(--primary);
    margin-bottom: 30px;
    font-weight: 500;
  }
  
  .login-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 25px;
  }
  
  .login-input {
    width: 100%;
    padding: 14px 15px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 16px;
    transition: all 0.3s;
  }
  
  .login-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(109, 142, 209, 0.2);
  }
  
  .login-btn {
    width: 100%;
    padding: 14px 15px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 500;
  }
  
  .login-btn:hover {
    background: var(--primary-light);
  }
  
  .divider {
    display: flex;
    align-items: center;
    margin: 25px 0;
    color: var(--text-light);
  }
  
  .divider::before,
  .divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }
  
  .divider span {
    padding: 0 15px;
    font-size: 14px;
  }
  
  .google-login-btn {
    width: 100%;
    padding: 14px 15px;
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    transition: all 0.3s;
    font-weight: 500;
    margin-bottom: 20px;
  }
  
  .google-login-btn:hover {
    background: #f5f5f5;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .google-icon {
    width: 20px;
    height: 20px;
  }
  
  .loading {
    display: none;
    margin: 20px 0;
  }
  
  .loading.active {
    display: inline-block;
  }
  
  .spinner {
    width: 30px;
    height: 30px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* زر اختيار الصور */
  .image-upload-btn {
    width: 100%;
    padding: 12px 15px;
    background: #f8f9fa;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-bottom: 15px;
    transition: all 0.3s;
    color: var(--text-light);
  }
  
  .image-upload-btn:hover {
    background: #e9ecef;
    border-color: var(--primary);
    color: var(--text);
  }
  
  .image-preview {
    max-width: 100%;
    max-height: 200px;
    border-radius: 8px;
    margin-bottom: 15px;
    display: none;
  }
  
  .image-preview.active {
    display: block;
  }
  
  /* الشات الرئيسي */
  .chat-layout {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 20px;
    height: calc(100vh - 40px);
    max-height: 100vh;
  }
  
  /* الشريط الجانبي */
  .sidebar {
    background: var(--white);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  .user-profile {
    text-align: center;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 20px;
  }
  
  .user-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 15px;
    border: 3px solid var(--secondary);
  }
  
  .user-name {
    font-size: 18px;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 10px;
  }
  
  .admin-badge {
    background: #ff4757;
    color: white;
    padding: 3px 10px;
    border-radius: 15px;
    font-size: 12px;
    display: inline-block;
    margin-right: 10px;
  }
  
  .logout-btn {
    background: #ff4757;
    color: white;
    border: none;
    padding: 8px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    margin-top: 15px;
    transition: background 0.3s;
    width: 100%;
  }
  
  .logout-btn:hover {
    background: #ff6b81;
  }
  
  /* أدوات الإدمن */
  .admin-tools {
    background: #fff5f5;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    border: 1px solid #ffcccc;
    display: none;
  }
  
  .admin-tools h3 {
    color: #ff4757;
    margin-bottom: 15px;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .admin-tools h3 svg {
    width: 20px;
    height: 20px;
  }
  
  .admin-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 10px;
  }
  
  .admin-btn {
    background: #ff4757;
    color: white;
    border: none;
    padding: 8px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
  }
  
  .admin-btn:hover {
    background: #ff6b81;
  }
  
  .admin-btn.secondary {
    background: var(--primary);
  }
  
  .admin-btn.secondary:hover {
    background: var(--primary-light);
  }
  
  .admin-btn.danger {
    background: #ff4757;
  }
  
  .admin-btn.success {
    background: #4CAF50;
  }
  
  .admin-btn.warning {
    background: #ffa502;
  }
  
  /* نافذة الأوامر */
  .command-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    padding: 20px;
  }
  
  .command-modal-content {
    background: var(--white);
    padding: 20px;
    border-radius: 12px;
    width: 100%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
  }
  
  .command-modal h3 {
    color: var(--primary);
    margin-bottom: 15px;
    text-align: center;
  }
  
  .command-users-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 20px;
  }
  
  .command-user-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: #f9f9f9;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .command-user-item:hover {
    background: #e8f0fe;
  }
  
  .command-user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
  }
  
  .command-user-info {
    flex: 1;
    min-width: 0;
  }
  
  .command-user-name {
    font-weight: 600;
    font-size: 14px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .command-user-id {
    font-size: 12px;
    color: var(--text-light);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .command-modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }
  
  .command-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
  }
  
  .command-cancel {
    background: var(--border);
    color: var(--text);
  }
  
  /* منطقة الشات */
  .chat-area {
    display: flex;
    flex-direction: column;
    background: var(--white);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    height: 100%;
    max-height: 100vh;
  }
  
  .messages-container {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #fafafa;
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
  }
  
  .chat-locked {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 100;
    padding: 20px;
  }
  
  .chat-locked h3 {
    color: #ff4757;
    margin-bottom: 10px;
    text-align: center;
  }
  
  .message {
    display: flex;
    margin-bottom: 20px;
    max-width: 80%;
    animation: fadeIn 0.3s ease;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .message.other {
    align-self: flex-start;
  }
  
  .message.self {
    align-self: flex-end;
    flex-direction: row-reverse;
  }
  
  .message.admin {
    border-right: 3px solid #ff4757;
  }
  
  .message.system {
    border-right: 3px solid #4CAF50;
    max-width: 100%;
    justify-content: center;
  }
  
  .message.system .message-content {
    background: #e8f5e9;
    color: #2e7d32;
  }
  
  .message.muted {
    opacity: 0.5;
  }
  
  .message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    margin: 0 10px;
    flex-shrink: 0;
    cursor: pointer;
  }
  
  .message-content {
    background: var(--secondary);
    padding: 12px 16px;
    border-radius: 12px;
    max-width: calc(100% - 60px);
    position: relative;
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
  }
  
  .message.self .message-content {
    background: var(--primary-light);
    color: white;
  }
  
  .message.admin .message-content {
    background: #fff5f5;
    border: 1px solid #ffcccc;
  }
  
  .message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
    gap: 10px;
  }
  
  .message-name {
    font-weight: 600;
    font-size: 14px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex-shrink: 0;
  }
  
  .message.admin .message-name {
    color: #ff4757;
  }
  
  .message-time {
    font-size: 12px;
    color: var(--text-light);
    flex-shrink: 0;
  }
  
  .message.self .message-time {
    color: rgba(255, 255, 255, 0.8);
  }
  
  .message-text {
    line-height: 1.5;
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
  }
  
  .edited-badge {
    font-size: 10px;
    color: #888;
    margin-top: 5px;
    font-style: italic;
  }
  
  .message-image {
    max-width: 100%;
    max-height: 300px;
    border-radius: 8px;
    margin-top: 8px;
    cursor: pointer;
    transition: transform 0.3s;
  }
  
  .message-image:hover {
    transform: scale(1.02);
  }
  
  .delete-btn {
    position: absolute;
    left: -25px;
    top: 50%;
    transform: translateY(-50%);
    background: #ff4757;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    cursor: pointer;
    font-size: 12px;
    display: none;
    z-index: 10;
  }
  
  .message:hover .delete-btn {
    display: block;
  }
  
  /* إدخال الرسالة */
  .input-area {
    padding: 20px;
    border-top: 1px solid var(--border);
    background: var(--white);
    position: relative;
    flex-shrink: 0;
  }
  
  .chat-locked .input-area {
    filter: blur(2px);
    pointer-events: none;
  }
  
  .message-input-row {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  
  #message-input {
    flex: 1;
    padding: 12px 15px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 16px;
    resize: none;
    height: 60px;
    font-family: inherit;
    min-height: 40px;
    max-height: 120px;
  }
  
  #message-input:disabled {
    background: #f5f5f5;
    cursor: not-allowed;
  }
  
  #message-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(109, 142, 209, 0.2);
  }
  
  .input-buttons {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  
  #send-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.3s;
    flex-shrink: 0;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
  }
  
  #send-btn:disabled {
    background: #cccccc;
    cursor: not-allowed;
  }
  
  #send-btn:hover:not(:disabled) {
    background: var(--primary-light);
  }
  
  #image-upload-chat {
    background: #f8f9fa;
    color: var(--text);
    border: 1px solid var(--border);
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
  }
  
  #image-upload-chat::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23333'%3E%3Cpath d='M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z'/%3E%3C/svg%3E") center no-repeat;
    background-size: 20px 20px;
    opacity: 0.7;
  }
  
  #image-upload-chat:hover {
    background: #e9ecef;
    border-color: var(--primary);
  }
  
  .status {
    text-align: center;
    padding: 10px;
    font-size: 14px;
    color: var(--text-light);
    background: var(--secondary);
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
    flex-shrink: 0;
  }
  
  .chat-status {
    background: #fff5f5;
    color: #ff4757;
    padding: 10px;
    text-align: center;
    font-weight: bold;
  }
  
  /* إشعارات */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 3000;
    animation: slideIn 0.3s ease;
    border-right: 4px solid var(--primary);
    max-width: 300px;
  }
  
  .notification.error {
    border-right-color: #ff4757;
  }
  
  .notification.success {
    border-right-color: #4CAF50;
  }
  
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  /* التعديل للجوال */
  @media (max-width: 1024px) {
    .chat-layout {
      grid-template-columns: 1fr;
      height: calc(100vh - 20px);
      gap: 10px;
    }
    
    .sidebar {
      display: none;
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      max-width: 300px;
      z-index: 1001;
      border-radius: 0;
    }
    
    .sidebar.active {
      display: block;
      animation: slideInRight 0.3s ease;
    }
    
    @keyframes slideInRight {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
    
    .sidebar-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 50%;
      cursor: pointer;
      z-index: 1002;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .message {
      max-width: 90%;
    }
  }
  
  @media (max-width: 768px) {
    .container {
      padding: 10px;
    }
    
    .chat-area {
      border-radius: 8px;
    }
    
    .messages-container {
      padding: 15px;
    }
    
    .input-area {
      padding: 15px;
    }
  }
  
  /* نافذة عرض الصورة */
  .image-viewer {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 3000;
    padding: 20px;
  }
  
  .image-viewer img {
    max-width: 100%;
    max-height: 90vh;
    border-radius: 8px;
  }
  
  .close-viewer {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    cursor: pointer;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
</style>
</head>
<body>

<!-- شاشة تسجيل الدخول -->
<div id="loginScreen" class="login-screen">
  <div class="login-box">
    <h2>مرحباً بك في Discond</h2>
    
    <div class="login-form">
      <input type="text" id="usernameInput" class="login-input" placeholder="اسم المستخدم" required maxlength="20">
      <input type="email" id="emailInput" class="login-input" placeholder="البريد الإلكتروني (اختياري)">
      <button id="guestLoginBtn" class="login-btn">تسجيل الدخول كضيف</button>
    </div>
    
    <div class="divider">
      <span>أو</span>
    </div>
    
    <!-- زر تسجيل الدخول بـ Google -->
    <div id="g_id_onload"
         data-client_id="1009347423340-movq119nqjkv18b3eus1p63ebs587daj.apps.googleusercontent.com"
         data-context="signin"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>
    
    <div id="googleSignIn" class="g_id_signin" 
         data-type="standard" 
         data-size="large" 
         data-theme="filled_blue" 
         data-text="signin_with" 
         data-shape="pill" 
         data-logo_alignment="left">
    </div>
    
    <!-- مؤشر التحميل -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
    </div>
    
  </div>
</div>

<!-- نافذة الأوامر -->
<div id="commandModal" class="command-modal" style="display: none;">
  <div class="command-modal-content">
    <h3 id="commandModalTitle">اختر المستخدم</h3>
    <div class="command-users-list" id="commandUsersList">
      <!-- قائمة المستخدمين تظهر هنا -->
    </div>
    <div class="command-modal-buttons">
      <button id="commandCancelBtn" class="command-btn command-cancel">إلغاء</button>
    </div>
  </div>
</div>

<!-- نافذة عرض الصورة -->
<div id="imageViewer" class="image-viewer" style="display: none;">
  <img id="viewerImage" src="" alt="صورة">
  <button id="closeViewer" class="close-viewer">✕</button>
</div>

<!-- الشات الرئيسي -->
<div class="container" style="display: none;" id="mainApp">
  <div class="chat-layout">
    
    <!-- منطقة الدردشة -->
    <div class="chat-area">
      <!-- حالة قفل الدردشة -->
      <div id="chatLocked" class="chat-locked" style="display: none;">
        <h3>الدردشة مغلقة مؤقتاً</h3>
        <p id="lockReason">سيتم فتح الدردشة قريباً...</p>
        <p id="lockTime" style="font-size: 12px; color: #666;"></p>
      </div>
      
      <div id="messagesContainer" class="messages-container">
        <!-- الرسائل تظهر هنا -->
      </div>
      
      <div class="input-area">
        <div class="message-input-row">
          <textarea id="message-input" placeholder="اكتب رسالتك هنا..."></textarea>
          <div class="input-buttons">
            <input type="file" id="imageFileInput" accept="image/*" style="display: none;">
            <button id="image-upload-chat" title="إرسال صورة"></button>
            <button id="send-btn">إرسال</button>
          </div>
        </div>
      </div>
      
      <div class="status">
        <span id="onlineStatus">✓ متصل</span>
        • <span id="messageCount">0 رسالة</span>
      </div>
    </div>
    
    <!-- الشريط الجانبي -->
    <div class="sidebar" id="sidebar">
      <div class="user-profile">
        <img id="profileAvatar" class="user-avatar" src="https://ui-avatars.com/api/?name=مستخدم&background=6d8ed1&color=fff" alt="صورة الملف">
        <div class="user-name" id="profileName">
          <span id="adminBadge" class="admin-badge" style="display: none;">إدمن</span>
          اسم المستخدم
        </div>
        <div style="color: var(--text-light); font-size: 14px; margin-bottom: 10px;" id="userEmail">مستخدم نشط</div>
        <div style="color: var(--primary); font-size: 12px; background: #e8f0fe; padding: 5px 10px; border-radius: 15px; margin-bottom: 10px;">
          ID: <span id="userIdText">---</span>
        </div>
        
        <button id="logoutBtn" class="logout-btn">تسجيل الخروج</button>
      </div>
      
      <!-- أدوات الإدمن -->
      <div id="adminTools" class="admin-tools">
        <h3>أدوات الإدمن</h3>
        
        <div class="admin-buttons">
          <button id="lockBtn" class="admin-btn danger">
            قفل الدردشة
          </button>
          <button id="unlockBtn" class="admin-btn success">
            فتح الدردشة
          </button>
        </div>
        
        <div class="admin-buttons">
          <button id="muteBtn" class="admin-btn warning">
            كتم مستخدم
          </button>
          <button id="unmuteBtn" class="admin-btn warning">
            إزالة كتم
          </button>
        </div>
        
        <div class="admin-buttons">
          <button id="roleBtn" class="admin-btn secondary">
            ترقية لإدمن
          </button>
          <button id="unroleBtn" class="admin-btn secondary">
            إزالة إدمن
          </button>
        </div>
        
        <div style="margin-top: 15px;">
          <button id="clearChatBtn" class="admin-btn danger" style="width: 100%;">
            مسح المحادثة
          </button>
        </div>
        
        <div style="font-size: 11px; color: #666; margin-top: 10px; text-align: center;">
          اضغط على الزر لعرض قائمة المستخدمين
        </div>
      </div>
    </div>
    
    <!-- زر تبديل الشريط الجانبي للجوال -->
    <button id="sidebarToggle" class="sidebar-toggle" style="display: none;">☰</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, onValue, set, remove, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
  import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

  // إعداد Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyC8jmHxQ5tIwuh9J_Y9TpovequFVigiXYw",
    authDomain: "disconde-17f43.firebaseapp.com",
    databaseURL: "https://disconde-17f43-default-rtdb.firebaseio.com",
    projectId: "disconde-17f43",
    storageBucket: "disconde-17f43.firebasestorage.app",
    messagingSenderId: "1009347423340",
    appId: "1:1009347423340:web:a86dee5c542544ab223c49",
    measurementId: "G-8Q05LMTRDX"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const storage = getStorage(app);

  // مراجع قاعدة البيانات
  const messagesRef = ref(db, 'messages');
  const usersRef = ref(db, 'users');
  const chatSettingsRef = ref(db, 'settings/chat');
  const mutedUsersRef = ref(db, 'mutedUsers');

  // العناصر في الصفحة
  const loginScreen = document.getElementById('loginScreen');
  const mainApp = document.getElementById('mainApp');
  const loadingDiv = document.getElementById('loading');
  const usernameInput = document.getElementById('usernameInput');
  const emailInput = document.getElementById('emailInput');
  const guestLoginBtn = document.getElementById('guestLoginBtn');
  const profileName = document.getElementById('profileName');
  const profileAvatar = document.getElementById('profileAvatar');
  const adminBadge = document.getElementById('adminBadge');
  const userIdText = document.getElementById('userIdText');
  const userEmail = document.getElementById('userEmail');
  const messagesContainer = document.getElementById('messagesContainer');
  const messageInput = document.getElementById('message-input');
  const sendBtn = document.getElementById('send-btn');
  const messageCount = document.getElementById('messageCount');
  const onlineStatus = document.getElementById('onlineStatus');
  const chatLocked = document.getElementById('chatLocked');
  const lockReason = document.getElementById('lockReason');
  const lockTime = document.getElementById('lockTime');
  const logoutBtn = document.getElementById('logoutBtn');
  const imageFileInput = document.getElementById('imageFileInput');
  const imageUploadBtn = document.getElementById('image-upload-chat');
  const sidebar = document.getElementById('sidebar');
  const sidebarToggle = document.getElementById('sidebarToggle');
  const imageViewer = document.getElementById('imageViewer');
  const viewerImage = document.getElementById('viewerImage');
  const closeViewer = document.getElementById('closeViewer');
  
  // أدوات الإدمن
  const adminTools = document.getElementById('adminTools');
  const lockBtn = document.getElementById('lockBtn');
  const unlockBtn = document.getElementById('unlockBtn');
  const muteBtn = document.getElementById('muteBtn');
  const unmuteBtn = document.getElementById('unmuteBtn');
  const roleBtn = document.getElementById('roleBtn');
  const unroleBtn = document.getElementById('unroleBtn');
  const clearChatBtn = document.getElementById('clearChatBtn');
  
  // نافذة الأوامر
  const commandModal = document.getElementById('commandModal');
  const commandModalTitle = document.getElementById('commandModalTitle');
  const commandUsersList = document.getElementById('commandUsersList');
  const commandCancelBtn = document.getElementById('commandCancelBtn');

  // بيانات المستخدم الحالي
  let currentUser = {
    name: '',
    email: '',
    avatar: '',
    userId: '',
    googleId: '',
    shortId: '',
    isAdmin: false,
    isGuest: false
  };

  // متغيرات التحكم
  let chatLockedUntil = null;
  let mutedUsers = {};
  let messageCountValue = 0;
  let currentCommand = '';
  let editingMessageId = null;

  // منع التمرير الأفقي
  window.addEventListener('scroll', function(e) {
    if (window.innerWidth <= 1024) {
      window.scrollTo(0, 0);
    }
  });

  // منع الزوم على الجوال
  document.addEventListener('gesturestart', function(e) {
    e.preventDefault();
  });

  // عرض إشعار
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  // عرض/إخفاء التحميل
  function showLoading(show) {
    if (show) {
      loadingDiv.classList.add('active');
      guestLoginBtn.disabled = true;
    } else {
      loadingDiv.classList.remove('active');
      guestLoginBtn.disabled = false;
    }
  }

  // دالة لإنشاء ID قصير
  function generateShortId() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < 8; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  }

  // معالجة تسجيل الدخول كضيف
  async function handleGuestLogin() {
    const name = usernameInput.value.trim();
    const email = emailInput.value.trim();
    
    if (!name) {
      showNotification('الرجاء إدخال اسم المستخدم', 'error');
      usernameInput.focus();
      return;
    }
    
    showLoading(true);
    
    try {
      // إنشاء بيانات المستخدم الضيف
      currentUser.name = name;
      currentUser.email = email || 'ضيف';
      currentUser.avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=6d8ed1&color=fff`;
      currentUser.googleId = '';
      currentUser.shortId = generateShortId();
      currentUser.userId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      currentUser.isAdmin = false;
      currentUser.isGuest = true;
      
      // حفظ الجلسة في localStorage
      localStorage.setItem('discond_user', JSON.stringify(currentUser));
      
      // تسجيل الدخول
      await loginUser();
      
    } catch (error) {
      console.error('خطأ في تسجيل الدخول كضيف:', error);
      showNotification('حدث خطأ في تسجيل الدخول', 'error');
      showLoading(false);
    }
  }

  // معالجة استجابة Google
  async function handleCredentialResponse(response) {
    try {
      showLoading(true);
      
      const token = response.credential;
      
      // فك تشفير بيانات JWT
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const data = JSON.parse(atob(base64));
      
      // التحقق من صلاحية التوكن
      const currentTime = Math.floor(Date.now() / 1000);
      if (data.exp && data.exp < currentTime) {
        showNotification('انتهت صلاحية جلسة الدخول');
        showLoading(false);
        return;
      }
      
      // حفظ بيانات المستخدم
      currentUser.name = data.name;
      currentUser.email = data.email;
      currentUser.avatar = data.picture;
      currentUser.googleId = data.sub;
      currentUser.isGuest = false;
      
      // التحقق إذا كان المستخدم موجود مسبقاً
      const usersSnapshot = await new Promise((resolve) => {
        onValue(usersRef, (snapshot) => {
          resolve(snapshot);
        }, { onlyOnce: true });
      });
      
      let existingUser = null;
      if (usersSnapshot.exists()) {
        const users = usersSnapshot.val();
        for (const userId in users) {
          const user = users[userId];
          if (user.googleId === currentUser.googleId) {
            existingUser = { id: userId, ...user };
            break;
          }
        }
      }
      
      if (existingUser) {
        // استعادة بيانات المستخدم الحالية
        currentUser.userId = existingUser.id;
        currentUser.shortId = existingUser.shortId;
        currentUser.isAdmin = existingUser.isAdmin || false;
      } else {
        // إنشاء مستخدم جديد
        currentUser.userId = 'google_' + currentUser.googleId;
        currentUser.shortId = generateShortId();
        currentUser.isAdmin = false;
      }
      
      // حفظ الجلسة في localStorage
      localStorage.setItem('discond_user', JSON.stringify(currentUser));
      
      // تسجيل الدخول
      await loginUser();
      
    } catch (error) {
      console.error('خطأ في تسجيل الدخول بـ Google:', error);
      showNotification('حدث خطأ في تسجيل الدخول', 'error');
      showLoading(false);
    }
  }

  // تسجيل الدخول للمستخدم
  async function loginUser() {
    try {
      // حفظ/تحديث بيانات المستخدم في Firebase
      await set(ref(db, `users/${currentUser.userId}`), {
        name: currentUser.name,
        email: currentUser.email,
        googleId: currentUser.googleId || '',
        shortId: currentUser.shortId,
        avatar: currentUser.avatar,
        isAdmin: currentUser.isAdmin || false,
        isGuest: currentUser.isGuest || false,
        lastSeen: serverTimestamp(),
        joinedAt: serverTimestamp()
      });
      
      // تحديث واجهة المستخدم
      profileName.textContent = currentUser.name;
      profileAvatar.src = currentUser.avatar;
      userEmail.textContent = currentUser.email;
      userIdText.textContent = currentUser.shortId;
      
      // إخفاء شاشة التسجيل وإظهار الشات
      loginScreen.style.display = 'none';
      mainApp.style.display = 'block';
      
      // إخفاء الشريط الجانبي على الجوال
      if (window.innerWidth <= 1024) {
        sidebar.style.display = 'none';
        sidebarToggle.style.display = 'flex';
      }
      
      // مسح حقول الإدخال
      usernameInput.value = '';
      emailInput.value = '';
      
      // التركيز على حقل الرسالة
      setTimeout(() => {
        messageInput.focus();
      }, 100);
      
      // مراقبة صلاحية الإدمن
      monitorAdminStatus();
      // مراقبة إعدادات الدردشة
      monitorChatSettings();
      // مراقبة المستخدمين المكتومين
      monitorMutedUsers();
      
      showNotification(`مرحباً ${currentUser.name}!`, 'success');
      
    } catch (error) {
      console.error('خطأ في حفظ بيانات المستخدم:', error);
      showNotification('حدث خطأ في حفظ بيانات المستخدم', 'error');
    } finally {
      showLoading(false);
    }
  }

  // تسجيل الخروج
  async function logout() {
    if (confirm('هل تريد تسجيل الخروج؟')) {
      try {
        // مسح بيانات الجلسة
        localStorage.removeItem('discond_user');
        
        // إعادة تعيين Google Sign-In إذا كان مستخدم Google
        if (currentUser.googleId && window.google && window.google.accounts) {
          google.accounts.id.revoke(currentUser.email, done => {
            console.log('تم تسجيل الخروج من Google');
          });
        }
        
        // إعادة تعيين بيانات المستخدم
        currentUser = {
          name: '',
          email: '',
          avatar: '',
          userId: '',
          googleId: '',
          shortId: '',
          isAdmin: false,
          isGuest: false
        };
        
        // إظهار شاشة تسجيل الدخول
        mainApp.style.display = 'none';
        loginScreen.style.display = 'flex';
        
        showNotification('تم تسجيل الخروج بنجاح', 'success');
        
      } catch (error) {
        console.error('خطأ في تسجيل الخروج:', error);
        showNotification('حدث خطأ في تسجيل الخروج', 'error');
      }
    }
  }

  // التحقق من وجود جلسة سابقة
  async function checkExistingSession() {
    const savedUser = localStorage.getItem('discond_user');
    if (savedUser) {
      try {
        showLoading(true);
        
        const userData = JSON.parse(savedUser);
        
        // التحقق من صحة البيانات
        if (userData.userId && userData.name) {
          // تعيين بيانات المستخدم
          currentUser = userData;
          
          // تحديث واجهة المستخدم
          profileName.textContent = currentUser.name;
          profileAvatar.src = currentUser.avatar;
          userEmail.textContent = currentUser.email;
          userIdText.textContent = currentUser.shortId;
          
          // تحديث بيانات المستخدم في Firebase
          await set(ref(db, `users/${currentUser.userId}`), {
            name: currentUser.name,
            email: currentUser.email,
            googleId: currentUser.googleId || '',
            shortId: currentUser.shortId,
            avatar: currentUser.avatar,
            isAdmin: currentUser.isAdmin || false,
            isGuest: currentUser.isGuest || false,
            lastSeen: serverTimestamp(),
            joinedAt: serverTimestamp()
          });
          
          // إخفاء شاشة التسجيل وإظهار الشات
          loginScreen.style.display = 'none';
          mainApp.style.display = 'block';
          
          // إخفاء الشريط الجانبي على الجوال
          if (window.innerWidth <= 1024) {
            sidebar.style.display = 'none';
            sidebarToggle.style.display = 'flex';
          }
          
          // التركيز على حقل الرسالة
          setTimeout(() => {
            messageInput.focus();
          }, 100);
          
          // مراقبة صلاحية الإدمن
          monitorAdminStatus();
          // مراقبة إعدادات الدردشة
          monitorChatSettings();
          // مراقبة المستخدمين المكتومين
          monitorMutedUsers();
          
          showNotification(`مرحباً بعودتك ${currentUser.name}!`, 'success');
        } else {
          localStorage.removeItem('discond_user');
        }
      } catch (error) {
        console.error('خطأ في استعادة الجلسة:', error);
        localStorage.removeItem('discond_user');
      } finally {
        showLoading(false);
      }
    }
  }

  // مراقبة صلاحية الإدمن
  function monitorAdminStatus() {
    const userRef = ref(db, `users/${currentUser.userId}/isAdmin`);
    
    onValue(userRef, (snapshot) => {
      if (snapshot.exists()) {
        const isAdmin = snapshot.val();
        currentUser.isAdmin = isAdmin;
        
        // تحديث localStorage
        const savedUser = JSON.parse(localStorage.getItem('discond_user') || '{}');
        savedUser.isAdmin = isAdmin;
        localStorage.setItem('discond_user', JSON.stringify(savedUser));
        
        if (isAdmin) {
          adminBadge.style.display = 'inline-block';
          adminTools.style.display = 'block';
          profileName.style.color = '#ff4757';
        } else {
          adminBadge.style.display = 'none';
          adminTools.style.display = 'none';
          profileName.style.color = '';
        }
      }
    });
  }

  // مراقبة إعدادات الدردشة
  function monitorChatSettings() {
    onValue(chatSettingsRef, (snapshot) => {
      if (snapshot.exists()) {
        const settings = snapshot.val();
        
        // التحقق من حالة القفل
        if (settings.isLocked) {
          chatLocked.style.display = 'flex';
          lockReason.textContent = settings.lockReason || 'الدردشة مغلقة مؤقتاً من قبل الإدمن';
          
          if (settings.lockedUntil) {
            const lockDate = new Date(settings.lockedUntil);
            const now = new Date();
            const diff = lockDate - now;
            
            if (diff > 0) {
              const minutes = Math.ceil(diff / (1000 * 60));
              lockTime.textContent = `ستفتح بعد ${minutes} دقيقة`;
              chatLockedUntil = settings.lockedUntil;
            } else {
              // انتهت مدة القفل
              set(chatSettingsRef, {
                isLocked: false,
                lockedBy: null,
                lockReason: null,
                lockedUntil: null,
                lockedAt: null
              });
            }
          }
        } else {
          chatLocked.style.display = 'none';
          chatLockedUntil = null;
        }
        
        // تحديث حالة حقل الإدخال
        updateInputField(settings.isLocked);
      } else {
        // إذا لم توجد إعدادات، إنشاء إعدادات افتراضية
        set(chatSettingsRef, {
          isLocked: false,
          lockedBy: null,
          lockReason: null,
          lockedUntil: null,
          lockedAt: null
        });
      }
    });
  }

  // تحديث حقل الإدخال بناءً على حالة القفل
  function updateInputField(isLocked) {
    if (isLocked) {
      if (!currentUser.isAdmin) {
        messageInput.disabled = true;
        sendBtn.disabled = true;
        messageInput.placeholder = 'الدردشة مغلقة مؤقتاً...';
      } else {
        messageInput.disabled = false;
        sendBtn.disabled = false;
        messageInput.placeholder = 'أنت إدمن، يمكنك الكتابة...';
      }
    } else {
      messageInput.disabled = false;
      sendBtn.disabled = false;
      messageInput.placeholder = 'اكتب رسالتك هنا...';
    }
  }

  // مراقبة المستخدمين المكتومين
  function monitorMutedUsers() {
    onValue(mutedUsersRef, (snapshot) => {
      if (snapshot.exists()) {
        mutedUsers = snapshot.val();
      } else {
        mutedUsers = {};
      }
    });
  }

  // إظهار نافذة الأوامر
  async function showCommandModal(command, title) {
    currentCommand = command;
    commandModalTitle.textContent = title;
    commandUsersList.innerHTML = '';
    
    try {
      // جلب جميع المستخدمين من قاعدة البيانات
      const usersSnapshot = await new Promise((resolve) => {
        onValue(usersRef, (snapshot) => {
          resolve(snapshot);
        }, { onlyOnce: true });
      });
      
      if (usersSnapshot.exists()) {
        const users = usersSnapshot.val();
        const userArray = [];
        
        for (const userId in users) {
          const user = users[userId];
          
          // تخطي المستخدم الحالي
          if (userId === currentUser.userId) continue;
          
          userArray.push({
            id: userId,
            shortId: user.shortId || 'N/A',
            name: user.name,
            avatar: user.avatar,
            email: user.email || '',
            isAdmin: user.isAdmin || false
          });
        }
        
        // عرض المستخدمين
        userArray.forEach(user => {
          const userItem = document.createElement('div');
          userItem.className = 'command-user-item';
          userItem.dataset.userId = user.id;
          
          userItem.innerHTML = `
            <img src="${user.avatar}" class="command-user-avatar" alt="${user.name}"
                 onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=6d8ed1&color=fff'">
            <div class="command-user-info">
              <div class="command-user-name">${user.name} (${user.shortId}) ${user.isAdmin ? '[إدمن]' : ''}</div>
              <div class="command-user-id">${user.email || 'لا يوجد بريد'}</div>
            </div>
          `;
          
          userItem.addEventListener('click', () => {
            executeCommand(command, user.id, user.name, user.shortId);
            hideCommandModal();
          });
          
          commandUsersList.appendChild(userItem);
        });
        
        if (userArray.length === 0) {
          commandUsersList.innerHTML = '<p style="text-align: center; color: #666;">لا يوجد مستخدمون آخرون</p>';
        }
      } else {
        commandUsersList.innerHTML = '<p style="text-align: center; color: #666;">لا يوجد مستخدمون</p>';
      }
    } catch (error) {
      console.error('خطأ في تحميل المستخدمين:', error);
      commandUsersList.innerHTML = '<p style="text-align: center; color: #ff4757;">خطأ في تحميل المستخدمين</p>';
    }
    
    commandModal.style.display = 'flex';
  }

  // إخفاء نافذة الأوامر
  function hideCommandModal() {
    commandModal.style.display = 'none';
    currentCommand = '';
  }

  // زر قفل الدردشة
  lockBtn.addEventListener('click', () => {
    if (!currentUser.isAdmin) return;
    executeCommand('lock', null, null, null);
  });

  // زر فتح الدردشة
  unlockBtn.addEventListener('click', () => {
    if (!currentUser.isAdmin) return;
    executeCommand('unlock', null, null, null);
  });

  // زر كتم مستخدم
  muteBtn.addEventListener('click', () => {
    if (!currentUser.isAdmin) return;
    showCommandModal('mute', 'اختر المستخدم للكتم');
  });

  // زر إزالة كتم
  unmuteBtn.addEventListener('click', () => {
    if (!currentUser.isAdmin) return;
    showCommandModal('unmute', 'اختر المستخدم لإزالة الكتم');
  });

  // زر ترقية لإدمن
  roleBtn.addEventListener('click', () => {
    if (!currentUser.isAdmin) return;
    showCommandModal('role', 'اختر المستخدم لترقيته إلى إدمن');
  });

  // زر إزالة ترقية إدمن
  unroleBtn.addEventListener('click', () => {
    if (!currentUser.isAdmin) return;
    showCommandModal('unrole', 'اختر المستخدم لإزالة صلاحيات الإدمن');
  });

  // زر مسح المحادثة
  clearChatBtn.addEventListener('click', async () => {
    if (!currentUser.isAdmin) return;
    
    if (confirm('هل أنت متأكد من مسح جميع الرسائل؟ هذا الإجراء لا يمكن التراجع عنه.')) {
      try {
        await remove(messagesRef);
        showNotification('تم مسح جميع الرسائل بنجاح', 'success');
        
        // إرسال رسالة نظام
        await push(messagesRef, {
          userId: 'system',
          userName: 'النظام',
          userAvatar: 'https://cdn-icons-png.flaticon.com/512/1828/1828640.png',
          text: `قام ${currentUser.name} (${currentUser.shortId}) بمسح جميع الرسائل.`,
          timestamp: serverTimestamp(),
          isSystem: true
        });
      } catch (error) {
        console.error('خطأ في مسح الرسائل:', error);
        showNotification('حدث خطأ في مسح الرسائل', 'error');
      }
    }
  });

  // إلغاء نافذة الأوامر
  commandCancelBtn.addEventListener('click', hideCommandModal);

  // تنفيذ الأوامر
  async function executeCommand(command, targetUserId, targetUserName, targetShortId) {
    try {
      switch(command) {
        case 'lock':
          // قفل الدردشة للجميع إلا الإدمن
          await set(chatSettingsRef, {
            isLocked: true,
            lockedBy: currentUser.shortId,
            lockReason: 'الدردشة مقفولة من قبل الإدمن',
            lockedUntil: null,
            lockedAt: serverTimestamp()
          });
          
          await push(messagesRef, {
            userId: 'system',
            userName: 'النظام',
            userAvatar: 'https://cdn-icons-png.flaticon.com/512/1828/1828640.png',
            text: `قام ${currentUser.name} (${currentUser.shortId}) بقفل الدردشة. فقط الإدمن يستطيع الكتابة الآن.`,
            timestamp: serverTimestamp(),
            isSystem: true
          });
          
          showNotification('تم قفل الدردشة بنجاح', 'success');
          break;
          
        case 'unlock':
          // فتح الدردشة
          await set(chatSettingsRef, {
            isLocked: false,
            lockedBy: null,
            lockReason: null,
            lockedUntil: null,
            lockedAt: null
          });
          
          await push(messagesRef, {
            userId: 'system',
            userName: 'النظام',
            userAvatar: 'https://cdn-icons-png.flaticon.com/512/1828/1828640.png',
            text: `قام ${currentUser.name} (${currentUser.shortId}) بفتح الدردشة للجميع.`,
            timestamp: serverTimestamp(),
            isSystem: true
          });
          
          showNotification('تم فتح الدردشة بنجاح', 'success');
          break;
          
        case 'mute':
          if (!targetUserId) {
            showCommandModal('mute', 'اختر المستخدم للكتم');
            return;
          }
          
          // كتم المستخدم لمدة ساعة
          const muteUntil = new Date();
          muteUntil.setHours(muteUntil.getHours() + 1);
          
          await set(ref(db, `mutedUsers/${targetUserId}`), {
            mutedBy: currentUser.shortId,
            mutedUntil: muteUntil.toISOString(),
            mutedAt: serverTimestamp(),
            userName: targetUserName,
            shortId: targetShortId
          });
          
          await push(messagesRef, {
            userId: 'system',
            userName: 'النظام',
            userAvatar: 'https://cdn-icons-png.flaticon.com/512/1828/1828640.png',
            text: `قام ${currentUser.name} (${currentUser.shortId}) بكتم ${targetUserName} (${targetShortId}) لمدة ساعة.`,
            timestamp: serverTimestamp(),
            isSystem: true
          });
          
          showNotification(`تم كتم ${targetUserName} بنجاح`, 'success');
          break;
          
        case 'unmute':
          if (!targetUserId) {
            showCommandModal('unmute', 'اختر المستخدم لإزالة الكتم');
            return;
          }
          
          // إزالة كتم المستخدم
          await remove(ref(db, `mutedUsers/${targetUserId}`));
          
          await push(messagesRef, {
            userId: 'system',
            userName: 'النظام',
            userAvatar: 'https://cdn-icons-png.flaticon.com/512/1828/1828640.png',
            text: `قام ${currentUser.name} (${currentUser.shortId}) بإزالة كتم ${targetUserName} (${targetShortId}).`,
            timestamp: serverTimestamp(),
            isSystem: true
          });
          
          showNotification(`تم إزالة كتم ${targetUserName} بنجاح`, 'success');
          break;
          
        case 'role':
          if (!targetUserId) {
            showCommandModal('role', 'اختر المستخدم لترقيته إلى إدمن');
            return;
          }
          
          // ترقية المستخدم إلى إدمن
          await set(ref(db, `users/${targetUserId}/isAdmin`), true);
          
          // تحديث بيانات المستخدم في localStorage إذا كان هو نفسه
          if (targetUserId === currentUser.userId) {
            const savedUser = JSON.parse(localStorage.getItem('discond_user') || '{}');
            savedUser.isAdmin = true;
            localStorage.setItem('discond_user', JSON.stringify(savedUser));
            currentUser.isAdmin = true;
          }
          
          await push(messagesRef, {
            userId: 'system',
            userName: 'النظام',
            userAvatar: 'https://cdn-icons-png.flaticon.com/512/1828/1828640.png',
            text: `قام ${currentUser.name} (${currentUser.shortId}) بترقية ${targetUserName} (${targetShortId}) إلى إدمن.`,
            timestamp: serverTimestamp(),
            isSystem: true
          });
          
          showNotification(`تم ترقية ${targetUserName} إلى إدمن بنجاح`, 'success');
          break;
          
        case 'unrole':
          if (!targetUserId) {
            showCommandModal('unrole', 'اختر المستخدم لإزالة صلاحيات الإدمن');
            return;
          }
          
          // إزالة صلاحيات الإدمن
          await set(ref(db, `users/${targetUserId}/isAdmin`), false);
          
          // تحديث بيانات المستخدم في localStorage إذا كان هو نفسه
          if (targetUserId === currentUser.userId) {
            const savedUser = JSON.parse(localStorage.getItem('discond_user') || '{}');
            savedUser.isAdmin = false;
            localStorage.setItem('discond_user', JSON.stringify(savedUser));
            currentUser.isAdmin = false;
          }
          
          await push(messagesRef, {
            userId: 'system',
            userName: 'النظام',
            userAvatar: 'https://cdn-icons-png.flaticon.com/512/1828/1828640.png',
            text: `قام ${currentUser.name} (${currentUser.shortId}) بإزالة صلاحيات الإدمن من ${targetUserName} (${targetShortId}).`,
            timestamp: serverTimestamp(),
            isSystem: true
          });
          
          showNotification(`تم إزالة صلاحيات الإدمن من ${targetUserName} بنجاح`, 'success');
          break;
      }
      
    } catch (error) {
      console.error('خطأ في تنفيذ الأمر:', error);
      showNotification('حدث خطأ في تنفيذ الأمر', 'error');
    }
  }

  // رفع صورة إلى Firebase Storage
  async function uploadImage(file) {
    try {
      // التحقق من حجم الصورة
      if (file.size > 5 * 1024 * 1024) { // 5MB
        showNotification('حجم الصورة كبير جداً. الحد الأقصى 5MB', 'error');
        return null;
      }
      
      // التحقق من نوع الصورة
      if (!file.type.startsWith('image/')) {
        showNotification('الملف المختار ليس صورة', 'error');
        return null;
      }
      
      showLoading(true);
      
      // إنشاء اسم فريد للملف
      const timestamp = Date.now();
      const randomString = Math.random().toString(36).substring(7);
      const fileName = `chat_images/${currentUser.userId}_${timestamp}_${randomString}`;
      
      // رفع الصورة إلى Storage
      const fileRef = storageRef(storage, fileName);
      await uploadBytes(fileRef, file);
      
      // الحصول على رابط التحميل
      const downloadURL = await getDownloadURL(fileRef);
      
      showLoading(false);
      return downloadURL;
      
    } catch (error) {
      console.error('خطأ في رفع الصورة:', error);
      showLoading(false);
      showNotification('حدث خطأ في رفع الصورة', 'error');
      return null;
    }
  }

  // إرسال رسالة نصية
  async function sendTextMessage(text) {
    try {
      // التحقق من كتم المستخدم
      if (mutedUsers[currentUser.userId]) {
        const muteUntil = new Date(mutedUsers[currentUser.userId].mutedUntil);
        const now = new Date();
        
        if (muteUntil > now) {
          const diff = Math.ceil((muteUntil - now) / (1000 * 60));
          showNotification(`أنت مكتوم لمدة ${diff} دقيقة أخرى`, 'error');
          return false;
        } else {
          await remove(ref(db, `mutedUsers/${currentUser.userId}`));
        }
      }
      
      // إذا كان المستخدم يعدل رسالة
      if (editingMessageId) {
        await update(ref(db, `messages/${editingMessageId}`), {
          text: text,
          edited: true,
          editedAt: serverTimestamp()
        });
        
        editingMessageId = null;
        messageInput.placeholder = 'اكتب رسالتك هنا...';
        showNotification('تم تعديل الرسالة', 'success');
        return true;
      }
      
      // إضافة الرسالة إلى Firebase
      await push(messagesRef, {
        userId: currentUser.userId,
        shortId: currentUser.shortId,
        userName: currentUser.name,
        userAvatar: currentUser.avatar,
        text: text,
        timestamp: serverTimestamp(),
        isAdmin: currentUser.isAdmin,
        email: currentUser.email
      });
      
      return true;
      
    } catch (error) {
      console.error('خطأ في إرسال الرسالة:', error);
      showNotification('حدث خطأ في إرسال الرسالة', 'error');
      return false;
    }
  }

  // إرسال رسالة مع صورة
  async function sendImageMessage(imageUrl, caption = '') {
    try {
      // التحقق من كتم المستخدم
      if (mutedUsers[currentUser.userId]) {
        const muteUntil = new Date(mutedUsers[currentUser.userId].mutedUntil);
        const now = new Date();
        
        if (muteUntil > now) {
          const diff = Math.ceil((muteUntil - now) / (1000 * 60));
          showNotification(`أنت مكتوم لمدة ${diff} دقيقة أخرى`, 'error');
          return false;
        } else {
          await remove(ref(db, `mutedUsers/${currentUser.userId}`));
        }
      }
      
      // إضافة الرسالة إلى Firebase
      await push(messagesRef, {
        userId: currentUser.userId,
        shortId: currentUser.shortId,
        userName: currentUser.name,
        userAvatar: currentUser.avatar,
        text: caption,
        imageUrl: imageUrl,
        timestamp: serverTimestamp(),
        isAdmin: currentUser.isAdmin,
        email: currentUser.email
      });
      
      return true;
      
    } catch (error) {
      console.error('خطأ في إرسال الصورة:', error);
      showNotification('حدث خطأ في إرسال الصورة', 'error');
      return false;
    }
  }

  // إرسال رسالة
  async function sendMessage() {
    const text = messageInput.value.trim();
    const file = imageFileInput.files[0];
    
    // إذا لم يكن هناك نص ولا صورة
    if (!text && !file) {
      showNotification('الرجاء كتابة رسالة أو اختيار صورة', 'error');
      return;
    }
    
    // التحقق من قفل الدردشة
    if (chatLockedUntil) {
      const lockUntil = new Date(chatLockedUntil);
      const now = new Date();
      
      if (lockUntil > now && !currentUser.isAdmin) {
        showNotification('الدردشة مغلقة مؤقتاً. فقط الإدمن يستطيع الكتابة.', 'error');
        return;
      }
    }
    
    try {
      let success = false;
      
      // إذا كان هناك صورة
      if (file) {
        const imageUrl = await uploadImage(file);
        if (imageUrl) {
          success = await sendImageMessage(imageUrl, text);
        }
      } else {
        // إذا كان نص فقط
        success = await sendTextMessage(text);
      }
      
      if (success) {
        // مسح حقل الإدخال وملف الصورة
        messageInput.value = '';
        imageFileInput.value = '';
        messageInput.focus();
      }
      
    } catch (error) {
      console.error('خطأ في إرسال الرسالة:', error);
      showNotification('حدث خطأ في إرسال الرسالة', 'error');
    }
  }

  // دالة لتعديل الرسالة
  async function editMessage(messageId, currentText) {
    editingMessageId = messageId;
    messageInput.value = currentText;
    messageInput.focus();
    messageInput.placeholder = 'تعديل الرسالة...';
    showNotification('يمكنك الآن تعديل الرسالة', 'info');
  }

  // إرسال بالزر
  sendBtn.addEventListener('click', sendMessage);

  // إرسال بالإنتر
  messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // تسجيل الدخول بالإنتر
  usernameInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleGuestLogin();
    }
  });

  // اختيار صورة
  imageUploadBtn.addEventListener('click', () => {
    imageFileInput.click();
  });

  // عرض معاينة الصورة عند اختيارها
  imageFileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      if (file.size > 5 * 1024 * 1024) {
        showNotification('حجم الصورة كبير جداً. الحد الأقصى 5MB', 'error');
        imageFileInput.value = '';
        return;
      }
      
      if (!file.type.startsWith('image/')) {
        showNotification('الملف المختار ليس صورة', 'error');
        imageFileInput.value = '';
        return;
      }
      
      showNotification('تم اختيار صورة، اضغط إرسال لإرسالها', 'info');
    }
  });

  // استقبال الرسائل الجديدة
  const processedMessages = new Set();
  
  onChildAdded(messagesRef, (snapshot) => {
    const message = snapshot.val();
    const messageId = snapshot.key;
    
    // منع معالجة نفس الرسالة مرتين
    if (processedMessages.has(messageId)) return;
    processedMessages.add(messageId);
    
    // التحقق من كتم المستخدم المرسل
    if (mutedUsers[message.userId] && !currentUser.isAdmin) {
      const muteUntil = new Date(mutedUsers[message.userId].mutedUntil);
      const now = new Date();
      
      if (muteUntil > now) {
        return;
      }
    }
    
    // إنشاء عنصر الرسالة
    const messageDiv = document.createElement('div');
    
    // إضافة ID فريد للرسالة
    messageDiv.id = `msg-${messageId}`;
    
    if (message.userId === 'system') {
      messageDiv.className = 'message system';
    } else {
      messageDiv.className = `message ${message.userId === currentUser.userId ? 'self' : 'other'} ${message.isAdmin ? 'admin' : ''}`;
    }
    
    messageDiv.dataset.messageId = messageId;
    messageDiv.dataset.userId = message.userId;
    
    // تنسيق الوقت
    let timeString = 'الآن';
    if (message.timestamp) {
      const time = new Date(message.timestamp);
      if (!isNaN(time.getTime())) {
        timeString = time.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
      }
    }
    
    // تنسيق وقت التعديل
    let editedText = '';
    if (message.edited && message.editedAt) {
      const editedTime = new Date(message.editedAt);
      if (!isNaN(editedTime.getTime())) {
        editedText = `<div class="edited-badge">تم التعديل ${editedTime.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}</div>`;
      }
    }
    
    // إذا كانت رسالة النظام
    if (message.userId === 'system') {
      messageDiv.innerHTML = `
        <div class="message-content">
          <div class="message-text">${message.text}</div>
        </div>
      `;
    } else {
      // استخدام الـ ID القصير في العرض
      const displayName = `${message.userName} (${message.shortId || 'ID'})${message.isAdmin ? ' [إدمن]' : ''}`;
      
      // تحضير محتوى الصورة
      let imageContent = '';
      if (message.imageUrl) {
        imageContent = `<img src="${message.imageUrl}" class="message-image" onclick="viewImage('${message.imageUrl}')" alt="صورة">`;
      }
      
      messageDiv.innerHTML = `
        <img src="${message.userAvatar}" class="message-avatar" alt="${message.userName}"
             onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(message.userName)}&background=6d8ed1&color=fff'">
        <div class="message-content">
          <div class="message-header">
            <span class="message-name">${displayName}</span>
            <span class="message-time">${timeString}</span>
          </div>
          <div class="message-text">${message.text || ''}</div>
          ${imageContent}
          ${editedText}
        </div>
        ${currentUser.isAdmin && message.userId !== 'system' ? `<button class="delete-btn" onclick="deleteMessage('${messageId}')">×</button>` : ''}
      `;
      
      // إضافة حدث النقر المزدوج لتعديل الرسالة
      if (message.userId === currentUser.userId) {
        let clickTimer = 0;
        messageDiv.addEventListener('click', (e) => {
          if (e.target.classList.contains('delete-btn') || e.target.classList.contains('message-image')) {
            return;
          }
          
          if (clickTimer === 0) {
            clickTimer = setTimeout(() => {
              clickTimer = 0;
            }, 300);
          } else {
            clearTimeout(clickTimer);
            clickTimer = 0;
            editMessage(messageId, message.text || '');
          }
        });
      }
    }
    
    // إزالة الرسائل القديمة إذا تجاوز العدد 200
    const allMessages = messagesContainer.querySelectorAll('.message');
    if (allMessages.length > 200) {
      for (let i = 0; i < allMessages.length - 200; i++) {
        allMessages[i].remove();
      }
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  });

  // دالة حذف الرسالة
  window.deleteMessage = function(messageId) {
    if (!currentUser.isAdmin) return;
    
    if (confirm('هل تريد حذف هذه الرسالة؟')) {
      remove(ref(db, `messages/${messageId}`));
      showNotification('تم حذف الرسالة', 'success');
    }
  };

  // دالة عرض الصورة
  window.viewImage = function(imageUrl) {
    viewerImage.src = imageUrl;
    imageViewer.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  };

  // إغلاق نافذة عرض الصورة
  closeViewer.addEventListener('click', () => {
    imageViewer.style.display = 'none';
    viewerImage.src = '';
    document.body.style.overflow = 'auto';
  });

  // إغلاق النافذة بالضغط خارج الصورة
  imageViewer.addEventListener('click', (e) => {
    if (e.target === imageViewer) {
      imageViewer.style.display = 'none';
      viewerImage.src = '';
      document.body.style.overflow = 'auto';
    }
  });

  // تحديث عدد الرسائل
  onValue(messagesRef, (snapshot) => {
    if (snapshot.exists()) {
      const messages = snapshot.val();
      messageCountValue = Object.keys(messages).length;
    } else {
      messageCountValue = 0;
    }
    messageCount.textContent = `${messageCountValue} رسالة`;
  });

  // تحديث حالة الاتصال
  window.addEventListener('online', () => {
    onlineStatus.textContent = '✓ متصل';
    onlineStatus.style.color = '';
    
    if (currentUser.userId) {
      set(ref(db, `users/${currentUser.userId}/lastSeen`), serverTimestamp());
    }
  });
  
  window.addEventListener('offline', () => {
    onlineStatus.textContent = '✗ غير متصل';
    onlineStatus.style.color = '#ff4757';
  });

  // تبديل الشريط الجانبي على الجوال
  sidebarToggle.addEventListener('click', () => {
    sidebar.classList.toggle('active');
  });

  // إغلاق الشريط الجانبي عند الضغط خارجها
  document.addEventListener('click', (e) => {
    if (window.innerWidth <= 1024 && 
        sidebar.classList.contains('active') && 
        !sidebar.contains(e.target) && 
        e.target !== sidebarToggle) {
      sidebar.classList.remove('active');
    }
  });

  // تحجيم الشريط الجانبي تلقائياً
  window.addEventListener('resize', () => {
    if (window.innerWidth > 1024) {
      sidebar.style.display = 'block';
      sidebar.classList.remove('active');
      sidebarToggle.style.display = 'none';
    } else {
      sidebar.style.display = 'none';
      sidebarToggle.style.display = 'flex';
    }
  });

  // تفعيل الأزرار
  guestLoginBtn.addEventListener('click', handleGuestLogin);
  logoutBtn.addEventListener('click', logout);

  // التحقق من الجلسة عند تحميل الصفحة
  window.addEventListener('DOMContentLoaded', () => {
    checkExistingSession();
    // التركيز على حقل اسم المستخدم
    usernameInput.focus();
  });

  // جعل الدوال متاحة عالمياً لـ Google
  window.handleCredentialResponse = handleCredentialResponse;

</script>

</body>
</html>
